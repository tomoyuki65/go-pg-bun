# Go言語からPostgreSQLを使うためのサンプル
Docker環境でGo言語（Golang）からDBにPostgreSQL、マイグレーションにAtlas、ORMにBunを使う方法についてのサンプルです。  
  
<br>
  
## 動作要件
- Go: 1.25.5
- Echo: v4.15.0
- PostgreSQL: 18.1
  
<br>
  
## ローカル開発環境構築
### 1. 環境変数ファイルをリネーム
```
cp ./.env.example ./.env
```  
  
### 2. コンテナのビルドと起動
```
docker compose build --no-cache
docker compose up -d
```  
  
### 3. マイグレーションの初期化
以下のコマンドを実行し、マイグレーション管理用テーブルを追加  
```
docker compose exec api go run cmd/migrate/main.go init
```
> ※もしテスト用DBに実行したい場合は、オプション「env ENV=testing」を追加し、次のようなコマンド「docker compose exec api env ENV=testing go run cmd/migrate/main.go init」を実行して下さい。
  
### 4. マイグレーション状態の確認
マイグレーション状態を確認したい場合は以下のコマンドを実行  
```
docker compose exec api go run cmd/migrate/main.go status
```
  
### 5. マイグレーションの実行
```
docker compose exec api go run cmd/migrate/main.go migrate
```
> ※マイグレーション実行後、一度に実行したSQLを一つのグループとして管理しています。
  
### 6. コンテナの停止・削除
```
docker compose down
```  
> ※ボリュームも合わせて削除したい場合は、オプション「-v」を付けて実行して下さい。（例：docker compose down -v）  
  
<br>
  
## DBコンテナへの接続方法
### 1. DBコンテナへ接続
```
docker compose exec db bash
```  
### 2. PostgreSQLにログイン
```
PGPASSWORD=local-db-password psql -U local-db-user -d local-db-name
```  
> ※ユーザーなどは.envファイルの環境変数で設定
  
<br>
  
## サンプルSQL
・ユーザーテーブルの作成  
```
CREATE TABLE users (
  id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR NOT NULL,
  email VARCHAR NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```
  
・ユーザーを1件作成  
```
INSERT INTO users (name, email) VALUES ('田中太郎', 't.tanaka@example.com');
```
  
・全てのユーザーを取得  
```
SELECT * FROM users;
```
  
・メールアドレスを更新  
```
UPDATE users SET email = 'taro.tanaka@example.com' WHERE id = 1;
```
> ※updated_atに自動更新用のトリガーを設定すれば、UPDATE処理をトリガーとしてupdated_atカラムの自動更新も可能です。  
  
・対象ユーザーを削除  
```
DELETE FROM users WHERE id = 1;
```
  
<br>
  
## DBクライアントツール「pgAdmin」について
GUIで各種DB操作をしたい場合、OSSにPostgreSQL用のDBクライアントツール「pgAdmin 4」があります。  
PCがMacかつパッケージ管理に「Homebrew」を使っている場合は、以下のコマンドで簡単にインストール可能です。  
  
### 1. インストール方法
・「Homebrew」の最新化
```
brew update
```

・「pgAdmin 4」のインストール
```
brew install --cask pgadmin4
```
  
### 2. 接続設定
DBの接続設定は環境変数「.env」ファイルの内容を利用します。  
```
Host name/address: localhost
Port: 5432
Maintenance database: local-db-name
Username: local-db-user
Password: local-db-password
Save password?: Yes（有効化する）
```
  
### 3. SQLを実行したい場合
画面左のツリーから対象DB（例：go-pg-db > Database(2) > local-db-name）を右クリックしてメニューを開き、「Query Tool」をクリックするとSQL実行用の画面が開けます。  
  
SQLを記述後、画面上のメニューにある実行ボタン「▶︎」（左側のExecute scriptボタンは記述内容を全て実行するやつで、右側のExecute queryボタンは単一のSQLを実行するやつです）をクリックしてください。  
  
> ※デフォルトではオートコミット設定になっています。
  
<br>
  
## マイグレーション用のコマンド
### 1. マイグレーションファイルの新規作成
以下のコマンドを実行し、upとdown用の二つのファイルを作成します。  
upがマイグレーション実行用で、downがロールバック用です。  
```
docker compose exec api go run cmd/migrate/main.go create_sql [ファイル名]
```
> ※ファイル名の例「create_users_table」
  
### 2. マイグレーションのロールバック
```
docker compose exec api go run cmd/migrate/main.go rollback
```
> ※直前に実行したマイグレーションを一つのグループ単位とし、グループ単位で一つ前に戻します。  
  
<br>
  
## コード修正後に使うコマンド
ローカルサーバー起動中に以下のコマンドを実行可能です。  
  
### 1. go.modの修正
```
docker compose exec api go mod tidy
```  
  
### 2. フォーマット修正
```
docker compose exec api go fmt ./...
```  
  
### 3. コード解析チェック
```
docker compose exec api staticcheck ./...
```  
  
<br>
  
## サンプルAPIのエンドポイント
Base URL: http://localhost:8080  
  
- GET /  
ルート（Hello World）  
  
- POST /api/v1/users  
  ユーザーを作成  
  
- GET /api/v1/users  
  全てのユーザーを取得  
  
- GET /api/v1/users/sql  
  全てのユーザーを取得（SQL版）  

- GET /api/v1/users/:id  
  対象ユーザー取得  
  
- GET /api/v1/users/:id/sql  
  対象ユーザー取得（SQL版）  
  
- PUT /api/v1/users/:id  
  対象ユーザー更新  
  
- DELETE /api/v1/users/:id  
  対象ユーザー削除
  
<br>
  
## 参考記事  
[・DockerとGo言語（Golang）からPostgreSQLとORM「Bun」を使う方法](https://golang.tomoyuki65.com/how-to-use-postgresql-with-docker-and-golang)  
  